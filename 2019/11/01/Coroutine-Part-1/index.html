<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">

    

    
    <title>[Android] Coroutine Document #1 | VictoryWoo</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
        <meta name="keywords" content="Android,Coroutine,Basic">
    
    <link rel="stylesheet" href="https://cdn.rawgit.com/innks/NanumSquareRound/master/nanumsquareround.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/theeluwin/NotoSansKR-Hestia@master/stylesheets/NotoSansKR-Hestia.css">
    <meta name="description" content="Coroutine Intro 시리즈를 통해서 개략적으로 알아보고 제대로 접근하려 했는데, 뭐 아는게 없으니 개략적으로 접근하기도 어렵다. 그냥 처음부터 제대로 접근하는 편이 나을 것 같아 괜찮은 글을 번역하면서 정리하려고 한다.  이 시리즈가 끝나면 공식 문서에 대해서 정리하려고 계획 중이다. 한 번에 이해하기 어렵다보니 여러 글들을 참고해서 정리하고 이해">
<meta name="keywords" content="Android,Coroutine,Basic">
<meta property="og:type" content="article">
<meta property="og:title" content="[Android] Coroutine Document #1">
<meta property="og:url" content="http://victorywoolee/victorywoolee.github.io/2019/11/01/Coroutine-Part-1/index.html">
<meta property="og:site_name" content="VictoryWoo">
<meta property="og:description" content="Coroutine Intro 시리즈를 통해서 개략적으로 알아보고 제대로 접근하려 했는데, 뭐 아는게 없으니 개략적으로 접근하기도 어렵다. 그냥 처음부터 제대로 접근하는 편이 나을 것 같아 괜찮은 글을 번역하면서 정리하려고 한다.  이 시리즈가 끝나면 공식 문서에 대해서 정리하려고 계획 중이다. 한 번에 이해하기 어렵다보니 여러 글들을 참고해서 정리하고 이해">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://victorywoolee/image/animation.gif">
<meta property="og:updated_time" content="2019-11-03T12:54:54.076Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="[Android] Coroutine Document #1">
<meta name="twitter:description" content="Coroutine Intro 시리즈를 통해서 개략적으로 알아보고 제대로 접근하려 했는데, 뭐 아는게 없으니 개략적으로 접근하기도 어렵다. 그냥 처음부터 제대로 접근하는 편이 나을 것 같아 괜찮은 글을 번역하면서 정리하려고 한다.  이 시리즈가 끝나면 공식 문서에 대해서 정리하려고 계획 중이다. 한 번에 이해하기 어렵다보니 여러 글들을 참고해서 정리하고 이해">
<meta name="twitter:image" content="http://victorywoolee/image/animation.gif">
    

    
        <link rel="alternate" href="/" title="VictoryWoo" type="application/atom+xml">
    

    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/titillium-web/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/3.3.1/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    


</head>
</html>
<body>
    <div id="wrap">
        <header id="header">
    <div id="header-outer" class="outer">
        <div class="container">
            <div class="container-inner">
                <div id="header-title">
                    <h1 class="logo-wrap">
                        <a href="/" class="logo"></a>
                    </h1>
                    
                        <h2 class="subtitle-wrap">
                            <p class="subtitle">VictoryWoo&#39;s Blog</p>
                        </h2>
                    
                </div>
                <div id="header-inner" class="nav-container">
                    <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
                    <div class="nav-container-inner">
                        <ul id="main-nav">
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/">Home</a>
                                </li>
                            
                                        <ul class="main-nav-list"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Android/">Android</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Clean-Code/">Clean Code</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/ETC/">ETC</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Git/">Git</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/Kotlin/">Kotlin</a></li></ul>
                                    
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/about/index.html">About</a>
                                </li>
                            
                        </ul>
                        <nav id="sub-nav">
                            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
        <div class="container">
            <div class="main-body container-inner">
                <div class="main-body-inner">
                    <section id="main">
                        <div class="main-body-header">
    <h1 class="header">
    
    <a class="page-title-link" href="/categories/Android/">Android</a>
    </h1>
</div>

                        <div class="main-body-content">
                            <article id="post-Coroutine-Part-1" class="article article-single article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
        [Android] Coroutine Document #1
        </h1>
    

            </header>
        
        
            <div class="article-meta">
                
    <div class="article-date">
        <a href="/2019/11/01/Coroutine-Part-1/" class="article-date">
            <time datetime="2019-11-01T14:32:25.000Z" itemprop="datePublished">2019-11-01</time>
        </a>
    </div>

		

                
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Android/">Android</a>, <a class="tag-link" href="/tags/Basic/">Basic</a>, <a class="tag-link" href="/tags/Coroutine/">Coroutine</a>
    </div>

            </div>
        
        
        <div class="article-entry" itemprop="articleBody">
            <p>Coroutine Intro 시리즈를 통해서 개략적으로 알아보고 제대로 접근하려 했는데, 뭐 아는게 없으니 개략적으로 접근하기도 어렵다. 그냥 처음부터 제대로 접근하는 편이 나을 것 같아 괜찮은 글을 번역하면서 정리하려고 한다. </p>
<p>이 시리즈가 끝나면 공식 문서에 대해서 정리하려고 계획 중이다. 한 번에 이해하기 어렵다보니 여러 글들을 참고해서 정리하고 이해하는 게 필자한테 도움이 더 될 것 같아서다. 그리고 실제 코드에 적용하면서 내 것으로 만들도록 노력할 것이다.</p>
<p>해당 글은 아래의 블로그를 참고해서 작성한 정리 글이다.<br><a href="https://medium.com/androiddevelopers/coroutines-on-android-part-i-getting-the-background-3e0e54d20bb" target="_blank" rel="noopener">Coroutines on Android (part I): Getting the background</a></p>
<h2 id="코루틴은-어떤-문제를-해결할까"><a href="#코루틴은-어떤-문제를-해결할까" class="headerlink" title="코루틴은 어떤 문제를 해결할까?"></a>코루틴은 어떤 문제를 해결할까?</h2><ul>
<li>코틀린 코루틴은 안드로이드에서 비동기 코드를 단순화하는데 사용할 수 있는 새로운 스타일의 동시성에 관한 것을 도입했다.</li>
<li>코틀린 1.3에서 코루틴이 새롭게 밝혀졌지만, 코루틴의 개념은 프로그래밍 언어가 시작된 이래 계속 존재했었다. 코루틴을 사용한 첫 언어는 Simula였다.</li>
<li>지난 몇년 동안 코루틴은 인기가 높아졌으며 지금은 JavaScript, C#, Python, Ruby 등과 같은 인기 있는 프로그래밍 언어에 포함되었다.</li>
<li>Kotlin 코루틴은 대규모 응용 프로그램을 구축하는데 사용된 기존 개념을 기반으로 한다.</li>
</ul>
<p>Android에서 코루틴을 다음 두 가지 문제에 대한 훌륭한 해결책이라고 할 수 있다. 즉, 코루틴의 사용 목적이라고 해석할 수도 있다.</p>
<p><strong>1. Long running tasks</strong></p>
<p>웹 페이지를 가져오거나 API와 상호 작용하기 위해서는 네트워크 요청을 해야 한다. 마찬가지로 데이터베이스에서 데이터를 읽거나 디스크에서 이미지를 로드하는 것은 파일을 읽는 것이다. 이런 종류들을 <strong>Long running tasks</strong>라 부른다. <strong>즉, 너무 오랜 시간이 걸려서 앱이 정지하고 오래 걸리는 작업들을 기다려야 하는 것이다.</strong></p>
<p>Android에서 모든 앱에는 UI 처리 및 사용자 상호 작용 조정을 담당하는 기본 스레드가 존재한다. 이 스레드에서는 너무 많은 작업이나 시간이 오래 걸리는 작업이 발생하면 앱이 중단되거나 느려져 바람직하지 않은 사용자 경험이 발생한다. 그래서 기본적으로 장시간 실행되는 작업은 시간이 오래 걸려 메인 스레드를 차단한다.</p>
<p>Long running tasks는 메인 스레드를 차단하지 않고 완료되어야 한다. 그래서 애플리케이션은 정지된 애니메이션, 터치 이벤트에 느리게 반응하는 등의 모습을 보여주어서는 안된다.</p>
<p><strong>2. Main safety</strong></p>
<p>메인 스레드에서 suspend 함수가 호출되는 것을 보장해준다. 즉, 메인 쓰레드에서 오래 걸리는 작업을 실행하는 코루틴 코드를 실행시켜도 되게끔 하는 것이다. 위에서는 메인 쓰레드에서 오래 걸리는 작업을 피하라고 했는데 이와 상충되는 의견일 수 있다.</p>
<p>보통 쓰레드에서는 별도의 쓰레드를 만들고 그 안에서 오래 걸리는 작업을 실행시킨다. 그러나 코루틴 프레임워크를 사용하면 메인 쓰레드에서 오래 걸리는 작업을 실행시켜도 알아서 쓰레드 관리가 되어지기 때문에 그럴 필요가 없다. 즉, <strong>쓰레드 관리가 더 쉬워진다.</strong>(이유는 코루틴이 내부적으로 알아서 적절한 쓰레드를 쓰기 때문이다.)</p>
<p>자, 그럼 정리하면 코루틴이 달성하려는 목적은 두 가지로 요약할 수 있다. 먼저, 시간이 오래 걸리는 작업을 메인 쓰레드에서 수행해도 메인 쓰레드가 멈추지 않게 할 수 있다. 그리고 두 번째로 메인 쓰레드에서 오래 걸리는 작업을 실행하는 코루틴 코드를 실행시켜도 상관이 없게 할 수 있다.</p>
<p>메인 스레드에서 네트워크 요청을 수행하기 위해 사용하는 일반적인 패턴은 콜백 패턴이다. 이는 훌륭한 패턴 중 하나이다. 콜백 패턴은 나중에 코드를 다시 호출하는 데 사용할 수 있는 라이브러리에 대한 핸들을 제공한다. </p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">viewModel</span>: <span class="type">ViewModel</span></span>()&#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">fetchDocs</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">get</span>(<span class="string">"developer.android.com"</span>)&#123; result -&gt;</span><br><span class="line">            show(result)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>위의 코드에서 메인 스레드에서 get()을 호출했더라도 다른 스레드를 사용해 네트워크 요청 작업을 수행한다. 그런 다음 네트워크로부터 결과를 사용할 수 있게 되면 기본 스레드에서 콜백이 호출될 것이다. </p>
<p>이는 Long running tasks를 처리하는 훌륭한 방법이며, Retrofit과 같은 라이브러리는 메인 스레드를 차단하지 않고도 네트워크 요청을 할 수 있도록 도와준다. 이게 가능한 이유는 Retrofit 내부에서 스레드를 관리 및 사용하기 때문이다.</p>
<h2 id="Using-coroutines-for-long-running-tasks"><a href="#Using-coroutines-for-long-running-tasks" class="headerlink" title="Using coroutines for long running tasks"></a>Using coroutines for long running tasks</h2><p>코루틴은 위에서 살펴봤던 <strong>fetchDocs</strong>와 같은 시간이 오래 걸리는 작업을 관리하는데 사용되는 코드를 단순화 하는 방법을 제공할 수 있다. 그러면 코루틴이 어떻게 이처럼 시간이 오래 걸리는 작업을 위한 코드를 단순화하는지 알아보고 이를 기존 코드에 적용해보자.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Dispatchers.Main</span></span><br><span class="line"><span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">fetchDocs</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// Dispatchers.Main</span></span><br><span class="line">    <span class="keyword">val</span> result = <span class="keyword">get</span>(<span class="string">"developer.android.com"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Dispatchers.Main</span></span><br><span class="line">    show(result)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">get</span><span class="params">(url: <span class="type">String</span>)</span></span> = withContext(Dispatchers.IO)&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>위의 코드는 기존의 콜백과는 무언가 조금 다르다. 그러면 위의 코드를 보고 드는 의문은 뭐가 있을까??</p>
<ul>
<li>이 코드는 메인 스레드를 차단하지 않는가?</li>
<li>네트워크 요청을 기다리거나 차단하지 않고 get에서 어떻게 결과를 반환하는가?</li>
<li>코루틴은 이 코드를 실행하고 메인 스레드를 차단하지 않는 방법을 제공한다.</li>
</ul>
<p>코루틴은 두 가지 새로운 연산을 추가함으로써 기존의 함수들을 기반으로 한다. 코루틴은 호출과 반환이외에도 <code>suspend</code>와 <code>resume</code>을 추가한다.</p>
<ul>
<li><code>suspend</code> : 현재 코루틴 실행을 일시 중지하고 모든 지역 변수를 저장</li>
<li><code>resume</code> : 일시 정지된 곳에서부터 suspended된 코루틴을 지속한다.</li>
</ul>
<p>이 기능은 Kotlin에 의해 함수의 suspend 키워드에 의해 추가된다. 그리고 다른 suspend 함수에서 suspend 함수를 호출하거나 새로운 코루틴을 시작하기 위해서 launch와 같은 코루틴 빌더를 사용할 수도 있다.</p>
<p><strong>콜백을 대체하기 위해서 suspend와 resume을 함께 사용한다.</strong> 이 말이 어떤 의미인지 이해하기 위해서 위에서 살펴봤던 예제를 다시 생각해보자.</p>
<p>get은 네트워크 요청을 시작하기 전에 코루틴을 일시 정지(suspend)한다. get 함수는 여전히 메인 스레드에서 네트워크 요청을 실행한다. 그런 다음 네트워크 요청이 완료되면 콜백을 호출해 메인 스레드에 알리는 것 대신에 일시 정지된 코루틴을 다시 시작할 수 있다.(resume)</p>
<img src="/image/animation.gif" width="600" height="500">

<p>위의 gif를 보면서 확인해보자. fetchDocs의 실행 방식을 살펴보면 suspend의 작동 방식을 확인할 수 있다. 코루틴이 일시 중단될 때마다 현재 스태 프레임(Kotlin이 실행중인 함수와 변수를 저장 및 추적하기 위해 사용하는 장소)은 나중에 복사 및 저장된다. 다시 시작되면 스택 프레임이 저장된 위치에서 다시 복사되고 다시 실행되기 시작한다.</p>
<p>애니메이션 도중 메인 스레드의 모든 코루틴이 일시 중단되면 메인 스레드는 자유롭게 화면을 업데이트하고 사용자 이벤트를 처리할 수 있다. <strong>동시에 suspend, resume을 깔끔하게 callbacks을 대체한다.</strong></p>
<p>여기서 강조할 점은 <strong>메인 스레드의 모든 코루틴이 일시 정지되면 메인 스레드는 다른 작업을 자유롭게 수행할 수 있다는 점이다.</strong></p>
<p>blocking 네트워크 요청과 비슷한 간단한 순차적 코드를 작성했지만, 코루틴은 코드를 원하는 방식으로 정확하게 실행하고 메인 스레드를 차단하지 않는다.</p>
<h2 id="Main-safety-with-coroutines"><a href="#Main-safety-with-coroutines" class="headerlink" title="Main-safety with coroutines"></a>Main-safety with coroutines</h2><p>Kotlin 코루틴에서 잘 작성된 suspend 함수들은 항상 메인 스레드에서 호출하는 것이 안전하다. 그 함수들이 무엇을 하든 그 함수들은 항상 어떤 스레드가 그들(함수)을 호출하도록 허용해야 한다.</p>
<p>위의 의미를 다시 한번 정리하면, suspend 함수들은 어떤 스레드에서라도 호출될 수 있도록 허용이 되야 한다는 것이다. 음, 아직까지 크게 와닿지 않는다. 더 살펴보자.</p>
<p>위와 같은 의미를 가진다하더라도 안드로이드 앱에서는 메인 스레드에서 수행하기에는 너무 느린 작업이 많이 존재한다. 예를 들면, 네트워크 요청, JSON 구문 분석, 데이터베이스에서 읽기 또는 쓰기, 심지어 큰 목록을 불러오는 것도 있다. 이 중 하나라도 사용자가 <strong>jank</strong>(화면 버벅임 현상)을 볼 수 있을 정도로 느리게 실행될 가능성이 있으면 메인 스레드 밖에서 실행해야 한다. </p>
<p>이는 우리가 안드로이드 개발을 하면서 비동기 작업을 수행하기 위해서 알고 있었던 사실 중 하나이다. 그렇기 때문에 이해하기가 그리 어렵지는 않다. </p>
<p>suspend를 사용한다고 해서 Kotlin이 백그라운드 스레드에서 함수를 실행하도록 지시하는 것은 아니다. 코루틴이 메인 스레드에서 실행될 것이라고 명확하고 자주 말해야 한다. 왜냐하면 우리가 까먹기 때문이다. 실제로 UI 이벤트에 대한 응답으로 코루틴을 시작할 때 Dispatchers.Main.immediate를 사용하는 것이 좋다. 이렇게 하면 Main-Safety가 필요한 Long running task를 수행하지 않으면 결과가 사용자의 바로 다음 프레임에서 사용할 수 있기 때문이다.</p>
<p><strong>다시 한 번 짚고 넘어가야 할 것은 코루틴은 메인 스레드에서 실행되며 suspend가 백그라운드를 의미하지 않는다는 것이다.</strong></p>
<p>메인 스레드 Main-safe에 비해 너무 느리게 작동하는 함수를 만들기 위해서 Kotlin 코루틴에게 Default 또는 IO dispatcher에서 작업을 수행하도록 지시할 수 있다. 코틀린에서는 모든 코루틴이 메인 스레드에서 실행될 때에도 dispatcher에서 실행되도록 해야 한다. 그리고 코루틴은 스스로 정지할 수 있으며 dispatcher는 스스로 resume하는 방법을 알고 있다.</p>
<p>코루틴이 실행되는 곳을 지정하기 위해 Kotlin은 스레드 디스패치에 사용할 수 있는 3개의 Dispatcher를 제공한다.</p>
<p><strong>1. Dispatchers.Main</strong></p>
<ul>
<li>안드로이드의 Main Thread</li>
<li>UI와 상호 작용을 한다.</li>
<li>가벼운 작업을 수행한다.</li>
<li>suspend 함수를 호출한다.</li>
<li>UI 함수를 호출한다.</li>
<li>LiveData를 업데이트한다.</li>
</ul>
<p><strong>2. Dispatchers.IO</strong></p>
<ul>
<li>메인 스레드에서 디스크 및 네트워크 IO 작업에 최적화되었다.</li>
<li>데이터베이스에서 파일을 읽거나 쓸 수 있고 네트워크 작업을 할 수 있다.</li>
</ul>
<p><strong>3. Dispatchers.Default</strong></p>
<ul>
<li>메인 스레드에서 CPU 집약적인 작업에 최적화되었다.</li>
<li>리스트를 정렬하거나 JSON을 파싱하거나, DiffUtils과 같은 작업을 수행한다.</li>
</ul>
<p>만약 suspend 함수, RxJava 또는 LiveData를 사용하면 Room이 자동으로 Main-Safety를 제공한다.</p>
<p>Retrofit 및 Volley와 같은 네트워킹 라이브러리는 자체적으로 스레드를 관리하며 Kotlin 코루틴과 함께 사용할 때 코드에서 명시적인 Main-Safety를 요구하지 않는다.</p>
<p>위의 예시를 계속해서 발전시켜보자. Dispatchers를 사용해 get 함수를 정의해보자. get() 함수 본문 내에서 withContext(Dispatchers.IO)를 호출하여 IO Dispatcher에서 실행될 블록을 만든다. 그러면 해당 블록에 넣은 코드는 항상 IO Dispatcher에서 실행된다. withContext 자체는 suspend 함수이기 때문에 코루틴을 사용하여 Main Safety을 제공한다.</p>
<p>아래의 간단한 코드와 주석을 통해서 다시 이해해보자.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Dispatchers.Main</span></span><br><span class="line"><span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">fetchDocs</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// Dispatchers.Main</span></span><br><span class="line">    <span class="keyword">val</span> result = <span class="keyword">get</span>(<span class="string">"developer.android.com"</span>)</span><br><span class="line">    <span class="comment">// Dispatchers.Main</span></span><br><span class="line">    show(result)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Dispatchers.Main</span></span><br><span class="line"><span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">get</span><span class="params">(url: <span class="type">String</span>)</span></span> = </span><br><span class="line">    withContext(Dispatchers.IO)&#123;</span><br><span class="line">        <span class="comment">// Dispatchers.IO</span></span><br><span class="line">        <span class="comment">// perform blocking network IO here</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Dispatchers.Main</span></span><br></pre></td></tr></table></figure>

<p>코루틴을 사용하면 세밀한 제어로 스레드 디스패치를 수행할 수 있다. <code>withContext</code>를 사용하면 결과를 반환하기 위해 콜백을 도입하지 않고도 코드가 실행되는 스레드를 제어할 수 있으므로 데이터베이스에서 파일을 읽거나 네트워크 요청을 수행하는 것과 같은 작은 함수에 적용할 수 있다. 따라서 Main을 포함한 모든 디스패처에서 모든 함수를 안전하게 호출할 수 있도록 <code>withContext</code>를 사용하는 것이 좋다. 이렇게하면 호출자가 함수를 실행하는데 어떤 스레드가 필요한지 생각할 필요가 없다.</p>
<p>위 예제에서 fetchDocs는 메인 스레드에서 실행되지만, 백그라운드에서 네트워크 요청을 수행하는 get() 함수를 안전하게 호출할 수 있다. 코루틴이 suspend와 resume을 지원하기 때문에 withContext 블록이 완료되는 즉시 메인 스레드의 코루틴이 결과와 함께 재시작된다.</p>
<p><strong>다시 강조하지만, 잘 작성된 suspend 함수는 항상 메인 스레드에서 호출하는 것이 안전하다.</strong></p>
<p>모든 suspend 함수를 기본적으로 Main safe하게 사용하는 것이 좋다. 디스크, 네트워크에 닿거나 너무 많은 CPU를 사용하는 작업을 수행하는 경우, withContext를 사용하여 메인 스레드에서 안전하게 호출해야 한다. 이는 Retrofit 및 Room과 같은 라이브러리를 기반으로 따르는 패턴이다. 만일 코드 베이스 전체에서 이 스타일을 따르는 경우, 코드가 훨씬 단순해지고 스레딩 문제를 응용 프로그램 논리와 혼용하지 않아도 된다. 일관성 있게 따라가면 코루틴은 메인 스레드에서 자유롭게 실행되며 간단한 코드로 네트워크 또는 데이터베이스 요청을 할 수 있으며 사용자에게 화면 버벅임과 같은 jank가 표시되지 않도록 한다.</p>
<h2 id="Performance-of-withContext-withContext의-성능"><a href="#Performance-of-withContext-withContext의-성능" class="headerlink" title="Performance of withContext(withContext의 성능)"></a>Performance of withContext(withContext의 성능)</h2><p>withContext는 Main safety를 제공하기 위해 콜백 또는 RxJava만큼 빠르다. 그리고 상황에 따라서 콜백으로 가능한 것 이상의 withContext 호출로 최적화할 수도 있다. 만약, 함수가 데이터베이스를 10번 호출할 경우, Kotlin에게 10개의 호출 주위에 있는 withContext를 한 번만 전환하도록 지시할 수 있다. 그런 다음 데이터베이스 라이브러리가 withContext를 반복적으로 호출하더라도 동일한 디스패처에 유지되고 빠른 경로를 따른다. 또한, Dispatchers.Default와 Dispatchers.IO 간 전환은 가능할 때마다 스레드 전환을 피하도록 최적화되어 있다.</p>
<h2 id="What’s-next"><a href="#What’s-next" class="headerlink" title="What’s next"></a>What’s next</h2><p>이번 포스트에서 코루틴이 어떤 문제를 해결하는지 살펴보았다. 코루틴은 프로그래밍 언어에서 매우 오래된 개념으로 최근 네트워크와 상호 작용하는 코드를 더 간단하게 만들 수 있는 기능으로 인해 대중화되었다.</p>
<p>그리고 위에서도 계속 언급했던 두 가지 문제를 해결하는데 간략하게 정리하면 다음과 같다.</p>
<ol>
<li>네트워크에서 읽기, 디스크 읽기, 대규모 JSON 결과 구문 분석과 같은 장기 실행 작업을 위한 코드를 단순화한다.</li>
<li>코드의 읽기 및 쓰기를 어렵게 하지 않으면서 메인 스레드를 실수로 차단하지 않도록 정확한 Main Safety를 수행한다.</li>
</ol>
<h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul>
<li><a href="https://medium.com/androiddevelopers/coroutines-on-android-part-i-getting-the-background-3e0e54d20bb" target="_blank" rel="noopener">Coroutines on Android (part I): Getting the background</a></li>
</ul>

        </div>
        <footer class="article-footer">
            



    <a data-url="http://victorywoolee/victorywoolee.github.io/2019/11/01/Coroutine-Part-1/" data-id="ck3cmzs3v0048qz3ro5y9rj72" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

        </footer>
    </div>
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "author": {
            "@type": "Person",
            "name": "Victory Woo"
        },
        "headline": "[Android] Coroutine Document #1",
        "image": "http://victorywoolee/victorywoolee.github.io/image/animation.gif",
        "keywords": "Android Coroutine Basic",
        "genre": "Android",
        "datePublished": "2019-11-01",
        "dateCreated": "2019-11-01",
        "dateModified": "2019-11-03",
        "url": "http://victorywoolee/victorywoolee.github.io/2019/11/01/Coroutine-Part-1/",
        "description": "Coroutine Intro 시리즈를 통해서 개략적으로 알아보고 제대로 접근하려 했는데, 뭐 아는게 없으니 개략적으로 접근하기도 어렵다. 그냥 처음부터 제대로 접근하는 편이 나을 것 같아 괜찮은 글을 번역하면서 정리하려고 한다. 
이 시리즈가 끝나면 공식 문서에 대해서 정리하려고 계획 중이다. 한 번에 이해하기 어렵다보니 여러 글들을 참고해서 정리하고 이해",
        "wordCount": 1737
    }
</script>

</article>

    <section id="comments">
    
        
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>

    
    </section>



                        </div>
                    </section>
                    <aside id="sidebar">
    <a class="sidebar-toggle" title="Expand Sidebar"><i class="toggle icon"></i></a>
    <div class="sidebar-top">
        <p>follow:</p>
        <ul class="social-links">
            
                
                <li>
                    <a class="social-tooltip" title="facebook" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-facebook"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="github" href="https://github.com/victorywoolee" target="_blank" rel="noopener">
                        <i class="icon fa fa-github"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="weibo" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-weibo"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="rss" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-rss"></i>
                    </a>
                </li>
                
            
        </ul>
    </div>
    
        
<nav id="article-nav">
    
        <a href="/2019/11/02/Coroutine-Part-2/" id="article-nav-newer" class="article-nav-link-wrap">
        <strong class="article-nav-caption">newer</strong>
        <p class="article-nav-title">
        
            [Android] Coroutine Document #2
        
        </p>
        <i class="icon fa fa-chevron-right" id="icon-chevron-right"></i>
    </a>
    
    
        <a href="/2019/11/01/Carousel/" id="article-nav-older" class="article-nav-link-wrap">
        <strong class="article-nav-caption">older</strong>
        <p class="article-nav-title">Carousel</p>
        <i class="icon fa fa-chevron-left" id="icon-chevron-left"></i>
        </a>
    
</nav>

    
    <div class="widgets-container">
        
            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">categories</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">23</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Clean-Code/">Clean Code</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/ETC/">ETC</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Git/">Git</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kotlin/">Kotlin</a><span class="category-list-count">17</span></li></ul>
        </div>
    </div>


            
                

            
                
    <div class="widget-wrap">
        <h3 class="widget-title">recents</h3>
        <div class="widget">
            <ul id="recent-post" class="no-thumbnail">
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Kotlin/">Kotlin</a></p>
                            <p class="item-title"><a href="/2019/11/24/Chap7-5/" class="title">[Kotlin] 위임 프로퍼티</a></p>
                            <p class="item-date"><time datetime="2019-11-24T05:19:15.000Z" itemprop="datePublished">2019-11-24</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Kotlin/">Kotlin</a></p>
                            <p class="item-title"><a href="/2019/11/24/Chap7-4/" class="title">[Kotlin] 구조 분해 선언과 Component 함수</a></p>
                            <p class="item-date"><time datetime="2019-11-24T04:56:35.000Z" itemprop="datePublished">2019-11-24</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Kotlin/">Kotlin</a></p>
                            <p class="item-title"><a href="/2019/11/23/Chap6-4/" class="title">[Kotlin] 타입 시스템 - 타입2</a></p>
                            <p class="item-date"><time datetime="2019-11-23T09:22:02.000Z" itemprop="datePublished">2019-11-23</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Kotlin/">Kotlin</a></p>
                            <p class="item-title"><a href="/2019/11/23/Chap6-3/" class="title">[Kotlin] 타입 시스템 - 타입</a></p>
                            <p class="item-date"><time datetime="2019-11-23T02:21:46.000Z" itemprop="datePublished">2019-11-23</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Android/">Android</a></p>
                            <p class="item-title"><a href="/2019/11/22/Android-CollapsingToolbarLayout/" class="title">[Android] CollapsingToolbarLayout</a></p>
                            <p class="item-date"><time datetime="2019-11-22T12:37:26.000Z" itemprop="datePublished">2019-11-22</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">archives</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a><span class="archive-list-count">26</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a><span class="archive-list-count">19</span></li></ul>
        </div>
    </div>


            
        
    </div>
</aside>

                </div>
            </div>
        </div>
        <footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a>
            <div class="credit">
                <h1 class="logo-wrap">
                    <a href="/" class="logo"></a>
                </h1>
                <p>&copy; 2019 Victory Woo</p>
                <p>Powered by <a href="//hexo.io/" target="_blank">Hexo</a>. Theme by <a href="//github.com/ppoffice" target="_blank">PPOffice</a></p>
            </div>
            <div class="footer-plugins">
              
    


            </div>
        </div>
    </div>
</footer>

        
    
    <script>
    var disqus_shortname = 'hexo-theme-hueman';
    
    
    var disqus_url = 'http://victorywoolee/victorywoolee.github.io/2019/11/01/Coroutine-Part-1/';
    
    (function() {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>




    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>
